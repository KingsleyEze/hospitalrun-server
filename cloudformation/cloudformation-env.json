{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "hospitalrun environment",

  "Parameters": {

    "ProjectName": {
      "Description": "name of deployed project",
      "Type": "String",
      "MinLength": 3
    },

    "Environment": {
      "Description": "Application environment",
      "Type": "String",
      "MinLength": 1
    },

    "HostedZone": {
      "Description": "Hosted zone name",
      "Type": "String",
      "MinLength": 3
    },

    "SNSTopic": {
      "Description": "ARN of SNS Topic for alarms",
      "Type": "String",
      "AllowedPattern": "arn:aws:sns:.*",
      "ConstraintDescription": "Expected valid SNS ARN (starting with arn:aws:sns:)."
    },

    "ConfigurationTemplate": {
      "Description": "Reference to Beanstalk ConfigurationTemplate",
      "Type": "String",
      "MinLength": 3
    },

    "ApplicationVersion": {
      "Description": "Reference to Benastalk ApplicationVersion",
      "Type": "String",
      "MinLength": 3
    },

    "Application": {
      "Description": "Reference to Beanstalk Application",
      "Type": "String",
      "MinLength": 3
    },

    "VPC": {
      "Description": "Reference to VPC",
      "Type": "String",
      "MinLength": 3
    },

    "Subnets": {
      "Description": "VPC subnets",
      "Type": "CommaDelimitedList"
    },


    "SpotPrice": {
      "Description": "Spot price",
      "Type": "String"
    },

    "InstanceType": {
      "Description": "Instance type",
      "Type": "String",
      "MinLength": 3
    }

  },

  "Mappings": {

    "Beanstalk2Route53HostedZoneId": {
      "us-east-1": { "HostedZoneId": "Z117KPS5GTRQ2G" },
      "us-west-1": { "HostedZoneId": "Z1LQECGX5PH1X" },
      "us-west-2": { "HostedZoneId": "Z38NKT9BP95V3O" },
      "eu-west-1": { "HostedZoneId": "Z3NF1Z3NOM5OY2" },
      "eu-central-1": { "HostedZoneId": "Z1FRNW7UH4DEZJ" },
      "ap-northeast-1": { "HostedZoneId": "Z1R25G3KIG2GBW" },
      "ap-northeast-2": { "HostedZoneId": "Z3JE5OI70TWKCP" },
      "ap-southeast-1": { "HostedZoneId": "Z16FZ9L249IFLT" },
      "ap-southeast-2": { "HostedZoneId": "Z2PCDNR3VC2G1N" },
      "sa-east-1": { "HostedZoneId": "Z10X7K2B4QSOFV" }
    }

  },

  "Resources": {
    "BeanstalkSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow access to Elastic Beanstalk instances.",
        "VpcId": { "Ref": "VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "80",  "ToPort": "80",  "CidrIp": "0.0.0.0/0" },
          { "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443", "CidrIp": "0.0.0.0/0" } ],
        "SecurityGroupEgress": [
          { "IpProtocol": "tcp", "FromPort": "0",  "ToPort": "65535",  "CidrIp": "0.0.0.0/0" }
        ]
      }
    },


    "BeanstalkEnvironment": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
         "ApplicationName": { "Ref": "Application" },
         "EnvironmentName":  { "Fn::Join": [ "-", [ { "Ref": "ProjectName" }, { "Ref": "Environment" } ] ] },
         "Description":  "Beanstalk environment",
         "VersionLabel": { "Ref": "ApplicationVersion" },
         "TemplateName": { "Ref": "ConfigurationTemplate" },
         "OptionSettings": [
           { "Namespace": "aws:autoscaling:launchconfiguration", "OptionName": "SecurityGroups", "Value": { "Ref": "BeanstalkSecurityGroup" } },
           { "Namespace": "aws:autoscaling:launchconfiguration", "OptionName": "InstanceType", "Value": { "Ref": "InstanceType" } },
           { "Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "SPOT_PRICE", "Value": { "Ref": "SpotPrice" } }
        ]
      }
    },

    "DNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "DependsOn": "BeanstalkEnvironment",
      "Properties": {
        "HostedZoneName": { "Fn::Join": [ "", [{"Ref": "HostedZone"}, "." ]]},
        "Comment": "DNS name",
        "Name": { "Fn::Join": [ "", [ { "Ref": "ProjectName" }, "-", { "Ref": "Environment" }, ".", { "Ref": "HostedZone" } ,"."] ] },
        "Type": "A",
        "AliasTarget": {
          "HostedZoneId": { "Fn::FindInMap": ["Beanstalk2Route53HostedZoneId", {"Ref": "AWS::Region"}, "HostedZoneId"]},
          "DNSName":  { "Fn::GetAtt": [ "BeanstalkEnvironment", "EndpointURL" ] }
        }
      }
    },

    "LogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": { "Fn::Join": [ "", [ { "Ref": "ProjectName" }, "-", { "Ref": "Environment" } ] ] },
        "RetentionInDays": 180
      }
    },

    "BytesTransferredMetricFilter": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": {
          "Ref": "LogGroup"
        },
        "FilterPattern": "[]",
        "MetricTransformations": [
          {
            "MetricValue": "$size",
            "MetricNamespace": { "Fn::Join": [ "", [ {"Ref": "ProjectName" }, "/" ] ] },
            "MetricName": { "Fn::Join": [ "", [ { "Ref": "Environment" } , "-", "BytesTransferred" ] ] }
          }
        ]
      }
    },

    "BandwidthAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": "The average volume of traffic is greater 3500 KB over 10 minutes",
        "MetricName": { "Fn::Join": [ "", [ { "Ref": "Environment" }, "-", "BytesTransferred" ] ] },
        "Namespace": { "Fn::Join": [ "", [ {"Ref": "ProjectName" }, "/" ] ] },
        "Statistic": "Average",
        "Period": "300",
        "EvaluationPeriods": "2",
        "Threshold": "3500",
        "AlarmActions": [ { "Ref": "SNSTopic" } ],
        "ComparisonOperator": "GreaterThanThreshold"
      }
    }

  },

  "Outputs": {

    "DNSName": {
      "Description": "DNS name",
      "Value": { "Ref": "DNSRecord" }
    }
  }

}
